<!DOCTYPE html>
<html>
<head>
    <title>FreeCAD model</title>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://rawgit.com/OLGGL/proto-gs/master/js/jquery-1.11.3.min.js"></script>
    <script src="https://rawgit.com/OLGGL/proto-gs/master/js/three.min.js"></script>
    <script src="https://rawgit.com/OLGGL/proto-gs/master/js/Detector.js"></script>
    <script src="https://rawgit.com/OLGGL/proto-gs/master/js/CanvasRenderer.js"></script>
    <script src="https://rawgit.com/OLGGL/proto-gs/master/js/Projector.js"></script>
    <script src="https://rawgit.com/OLGGL/proto-gs/master/js/dat.gui.js"></script>
    <script src="./modelUvs/Stool400160400115.js"></script>
    <script src="https://rawgit.com/OLGGL/proto-gs/master/js/TrackballControls.js"></script>

    <div id="WebGLCanvas">
    </div>
</head>
<body>
<script>
    var scene, camera;

    initializeScene();

    var H = dim.hauteur;
    var L = dim.longueur;
    var l1 = dim.largeur;
    var MAT = 'none';

    var tmp_rotation = 5.8;

    animateScene();

    jQuery.loadScript = function (url, callback) {
        jQuery.ajax({
            url: url,
            dataType: 'script',
            success: callback,
            async: true
        });
    };

    function initializeScene(){
        if(Detector.webgl){
            renderer = new THREE.WebGLRenderer({antialias:true});
        } else {
            renderer = new THREE.CanvasRenderer();
        }

        renderer.setClearColor(0x202020, 1);
        canvasWidth = 900;
        canvasHeight = 650;
        renderer.setSize(canvasWidth, canvasHeight);

        document.getElementById("WebGLCanvas").appendChild(renderer.domElement);

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(45, canvasWidth / canvasHeight, 1, 10000);
        camera.position.set(1000, 80, 750);
        var pos0 = new THREE.Vector3(0,80,200);
        camera.lookAt(pos0);
        console.log(scene.position);
        camera.rotation.z = 90 * Math.PI / 180;
        scene.add(camera);


        var material = new THREE.MeshBasicMaterial( { color: 0x888888 } );
        //var material = new THREE.MeshLambertMaterial( { map: THREE.ImageUtils.loadTexture('./bois3.jpg')});
        var g = Stool400160400115.geom();
        var mesh0 = new THREE.Mesh( g[0][0], material );
        var mesh1 = new THREE.Mesh( g[0][1], material );
        var mesh2 = new THREE.Mesh( g[0][2], material );
        var mesh3 = new THREE.Mesh( g[0][3], material );
        var mesh4 = new THREE.Mesh( g[0][4], material );
        var mesh5 = new THREE.Mesh( g[0][5], material );
        var mesh6 = new THREE.Mesh( g[0][6], material );
        scene.add(mesh0, mesh1, mesh2, mesh3, mesh3, mesh4, mesh5, mesh6);

        // add subtle ambient lighting
        var ambientLight = new THREE.AmbientLight(0xbbbbbb);
        scene.add(ambientLight);

        // directional lighting
        var directionalLight = new THREE.DirectionalLight(0xffffff);
        directionalLight.position.set(500, 500, 500).normalize();
        scene.add(directionalLight);


        setupGui();
    }

    function setupMesh(geometry,material){
        console.log(geometry);
        var mesh0 = new THREE.Mesh( geometry[0][0], material );
        var mesh1 = new THREE.Mesh( geometry[0][0], material );
        var mesh2 = new THREE.Mesh( geometry[0][1], material );
        var mesh3 = new THREE.Mesh( geometry[0][2], material );
        var mesh4 = new THREE.Mesh( geometry[0][3], material );
        var mesh5 = new THREE.Mesh( geometry[0][4], material );
        var mesh6 = new THREE.Mesh( geometry[0][5], material );
        scene.add(mesh0, mesh1, mesh2, mesh3, mesh3, mesh4, mesh5, mesh6);
    }

    function setupGui() {
        dim = {

            hauteur: 400,
            longueur: 400,
            largeur: 160,
            l2 : 115,
            rotation: "false",
            material : "none"
        };

        var h;

        var gui = new dat.GUI();

        gui.add( dim , "hauteur").min(350.).max(550.).step(50.);
        gui.add( dim , "longueur", 250, 450).step(50.);
        gui.add( dim , "largeur", 140, 260 ).step(20.);
        gui.add( dim , "material", ["none","bois1", "bois2"]);
        gui.add( dim, "rotation", ["true","false"]);

    }

    function animateScene(){

        if (dim.rotation == "true"){
            scene.traverse( function( node ) {
                if ( node instanceof THREE.Mesh || node instanceof THREE.Line) {
                    node.rotation.z += 0.01
                    tmp_rotation = node.rotation.z;
                }
            } );
        }
        requestAnimationFrame(animateScene);
        renderScene();
        //controls.update();
    }

    $.ajaxSetup({'cache':true});

    function renderScene(){
        if (dim.hauteur != H || dim.longueur != L || dim.largeur != l1 || dim.material != MAT ){
            H = dim.hauteur;
            L = dim.longueur;
            l1 = dim.largeur;
            MAT = dim.material;
            ModuleName = 'Stool'+String(dim.longueur)+String(dim.largeur)+String(dim.hauteur)+String(dim.l2);
            console.log(ModuleName);
            if (dim.material != "none"){
                jQuery.getScript('./modelUvs/'+ModuleName+'.js')
                        .done(function() {
                            remove = [];
                            scene.traverse( function( node ) {
                                if ( node instanceof THREE.Mesh || node instanceof THREE.Line) {
                                    remove.push(node);
                                }
                            } );
                            for (var i=0; i<remove.length; i++) {
                                scene.remove(remove[i]);
                            }
                            var codeToExecute = "return "+ModuleName+'.geom()';
                            var tmpFunc = new Function(codeToExecute);
                            geometry = tmpFunc();
                            setupMesh(geometry, new THREE.MeshBasicMaterial( { color: 0x888888 } ));
                            scene.traverse( function( node ) {
                                if ( node instanceof THREE.Mesh || node instanceof THREE.Line) {
                                    node.rotation.z =tmp_rotation;
                                }
                            } );
                        })
                        .fail(function() {
                            /* boo, fall back to something else */
                        });
            }
            else {
                jQuery.getScript('./model/'+ModuleName+'.js')
                        .done(function() {
                            remove = [];
                            scene.traverse( function( node ) {
                                if ( node instanceof THREE.Mesh || node instanceof THREE.Line) {
                                    remove.push(node);
                                }
                            } );
                            for (var i=0; i<remove.length; i++) {
                                scene.remove(remove[i]);
                            }
                            var codeToExecute = ModuleName+'.geom(scene)';
                            var tmpFunc = new Function(codeToExecute);
                            tmpFunc();
                            scene.traverse( function( node ) {
                                if ( node instanceof THREE.Mesh || node instanceof THREE.Line) {
                                    node.rotation.z =tmp_rotation;
                                }
                            } );
                        })
                        .fail(function() {
                            /* boo, fall back to something else */
                        });
            }
        }
        renderer.render(scene, camera);
    }
</script>
</body>
</html>